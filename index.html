<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gest√£o de Gastos</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: radial-gradient(circle at top, #1a1a1a, #000);
  color: #fff;
  padding: 20px;
}

.container {
  max-width: 420px;
  margin: auto;
  background: #141414;
  padding: 22px;
  border-radius: 22px;
  box-shadow: 0 30px 80px rgba(0,0,0,.6);
}

h2 {
  text-align: center;
  margin-bottom: 20px;
}

input, select, button {
  width: 100%;
  padding: 14px;
  margin-top: 12px;
  font-size: 15px;
  border-radius: 14px;
  border: none;
  background: #1f1f1f;
  color: #fff;
}

button {
  background: #fff;
  color: #000;
  font-weight: 600;
  cursor: pointer;
}

button:hover {
  opacity: .9;
}

.inline {
  display: flex;
  gap: 8px;
  align-items: center;
}

.icon-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  font-size: 18px;
  cursor: pointer;
}

.add { background:#2ecc71; color:#000; }
.del { background:#ff5f56; color:#000; }

.cards {
  display:flex;
  gap:10px;
  margin:14px 0;
}

.card {
  flex:1;
  background:#1f1f1f;
  padding:12px;
  border-radius:16px;
  text-align:center;
}

#gastosLista .item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:10px;
}

#logout {
  margin: 30px auto 0;
  display:block;
  width:120px;
}

#dark-toggle {
  position: fixed;
  top: 16px;
  right: 16px;
  font-size: 22px;
  cursor: pointer;
}

#comparacao {
  font-size:14px;
  opacity:.85;
  margin-top:8px;
  text-align:center;
}
</style>
</head>

<body>

<div id="dark-toggle" onclick="toggleDark()">üåô</div>

<div class="container">

<h2>üí∞ Gest√£o de Gastos</h2>

<!-- LOGIN -->
<div id="login">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Palavra-passe">
  <button onclick="login()">Entrar / Criar conta</button>
</div>

<!-- APP -->
<div id="app" style="display:none">

  <select id="mesSelecionado" onchange="carregarGastos()"></select>

  <input id="salario" type="number" placeholder="Sal√°rio mensal">

  <div class="cards">
    <div class="card">üêù Gastos<br><strong id="totalGastos">0.00</strong></div>
    <div class="card">üü¢ Saldo<br><strong id="saldo">0.00</strong></div>
  </div>

  <div class="inline">
    <select id="cat"></select>
    <button class="icon-btn add" onclick="addCategoria()">+</button>
    <button class="icon-btn del" onclick="delCategoria()">√ó</button>
  </div>

  <input id="desc" placeholder="Descri√ß√£o">
  <input id="val" type="number" placeholder="Valor (‚Ç¨)">
  <button onclick="addGasto()">Adicionar gasto</button>

  <div id="comparacao"></div>

  <h3>Gastos do m√™s</h3>
  <div id="gastosLista"></div>

  <canvas id="grafico" style="margin-top:20px"></canvas>

  <button id="logout" onclick="logout()">Sair</button>
</div>

</div>

<script>
/* üî• FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyA53gz5pwnzSFx4alP2Gb6L7N3qAvXmMdU",
  authDomain: "controle-financeiro-fafd9.firebaseapp.com",
  projectId: "controle-financeiro-fafd9"
});

const auth = firebase.auth();
const db = firebase.firestore();

let chart;
let categorias = ["Alimenta√ß√£o","Transporte","Renda","Lazer","Outros"];

/* AUTH */
auth.onAuthStateChanged(u=>{
  login.style.display = u ? "none" : "block";
  app.style.display = u ? "block" : "none";
  if(u){
    renderMeses();
    renderCategorias();
    carregarGastos();
  }
});

/* LOGIN */
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
  .catch(()=>auth.createUserWithEmailAndPassword(email.value,password.value));
}
function logout(){ auth.signOut(); }

/* MESES */
function renderMeses(){
  mesSelecionado.innerHTML="";
  const hoje = new Date();
  for(let i=0;i<12;i++){
    const d = new Date(hoje.getFullYear(), hoje.getMonth()-i, 1);
    const opt=document.createElement("option");
    opt.value=`${d.getFullYear()}-${d.getMonth()}`;
    opt.text=`${d.toLocaleString("pt",{month:"long"})} de ${d.getFullYear()}`;
    mesSelecionado.appendChild(opt);
  }
}

/* CATEGORIAS */
function renderCategorias(){
  cat.innerHTML="";
  categorias.forEach(c=>{
    const o=document.createElement("option");
    o.textContent=c;
    cat.appendChild(o);
  });
}
function addCategoria(){
  const n=prompt("Nova categoria:");
  if(n && !categorias.includes(n)){ categorias.push(n); renderCategorias(); }
}
function delCategoria(){
  if(confirm("Apagar esta categoria?")){
    categorias=categorias.filter(c=>c!==cat.value);
    renderCategorias();
  }
}

/* GASTOS */
function addGasto(){
  if(!val.value) return;
  const [ano,mes]=mesSelecionado.value.split("-").map(Number);
  db.collection("gastos").add({
    uid:auth.currentUser.uid,
    desc:desc.value,
    cat:cat.value,
    val:+val.value,
    mes,ano
  });
  desc.value=""; val.value="";
}

function carregarGastos(){
  const [ano,mes]=mesSelecionado.value.split("-").map(Number);
  db.collection("gastos")
  .where("uid","==",auth.currentUser.uid)
  .where("ano","==",ano)
  .where("mes","==",mes)
  .onSnapshot(s=>{
    let total=0, cats={};
    gastosLista.innerHTML="";
    s.forEach(d=>{
      const g=d.data();
      total+=g.val;
      cats[g.cat]=(cats[g.cat]||0)+g.val;
      gastosLista.innerHTML+=`
        <div class="item">
          <span>${g.desc}</span>
          <span>‚Ç¨${g.val.toFixed(2)}</span>
        </div>`;
    });
    totalGastos.textContent=total.toFixed(2);
    saldo.textContent=(salario.value-total).toFixed(2);
    compararMeses(total);
    desenharGrafico(cats);
  });
}

/* COMPARA√á√ÉO */
function compararMeses(total){
  const [ano,mes]=mesSelecionado.value.split("-").map(Number);
  let ma=mes-1, aa=ano;
  if(ma<0){ma=11;aa--;}
  db.collection("gastos")
  .where("uid","==",auth.currentUser.uid)
  .where("ano","==",aa)
  .where("mes","==",ma)
  .get().then(s=>{
    let t=0;
    s.forEach(d=>t+=d.data().val);
    const diff=total-t;
    comparacao.textContent=
      `M√™s anterior: ‚Ç¨${t.toFixed(2)} | Diferen√ßa: ${diff>=0?"‚Üë":"‚Üì"} ‚Ç¨${Math.abs(diff).toFixed(2)}`;
  });
}

/* GR√ÅFICO */
function desenharGrafico(c){
  if(chart) chart.destroy();
  chart=new Chart(grafico,{
    type:"pie",
    data:{labels:Object.keys(c),datasets:[{data:Object.values(c)}]}
  });
}

/* DARK */
function toggleDark(){
  document.body.classList.toggle("dark");
  dark-toggle.textContent=document.body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";
}
</script>

</body>
</html>
